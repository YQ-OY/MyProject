<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wangchai.mapper.EmpMapper">
    <!--    查询当前年份入职的人数    -->
    <select id="countData" resultType="java.lang.Long">

        SELECT COUNT(*) AS current_year_entry_count
        FROM EMP

        WHERE EXTRACT(YEAR FROM ENTRYDAY) = EXTRACT(YEAR FROM SYSDATE)
    </select>

    <!-- 分页+条件查询的SQL -->
    <select id="selectEmpVoPage" resultType="com.wangchai.domain.vo.EmpVo">
        SELECT
        e.EMP_ID AS empId,
        e.PHOTO AS photo,
        e.NAME AS name,
        e.GENDER AS gender,
        d.NAME AS deptName,
        e.JOB AS job,
        e.BIRTHDAY AS birthday,
        e.ENTRYDAY AS entryday,
        e.MANAGER_ID AS managerId,
        m.NAME AS managerName
        FROM
        EMP e
        LEFT JOIN DEPT d ON e.DEPT_ID = d.DEPT_ID
        LEFT JOIN EMP m ON e.MANAGER_ID = m.EMP_ID
        <where>
            <!-- 条件1：姓名模糊查询 -->
            <if test="dto.name != null and dto.name != ''">
                AND e.NAME LIKE '%' || #{dto.name} || '%'
            </if>
            <!-- 条件2：主管编号精准查询（数字类型用=，不用like） -->
            <if test="dto.managerId != null">
                AND e.MANAGER_ID = #{dto.managerId}
            </if>
            <if test="dto.deptName != null and dto.deptName.size() > 0">
                AND d.NAME IN
                <foreach collection="dto.deptName" item="dept" open="(" separator="," close=")">
                    #{dept}
                </foreach>
            </if>
        </where>
        ORDER BY e.EMP_ID
    </select>

    <!-- 查询年龄区间+性别统计 -->
    <select id="EmployeeAgeDistData" resultType="com.wangchai.domain.vo.EmpAgeDistVo">
        SELECT
            CASE
                WHEN AGE BETWEEN 18 AND 25 THEN '18-25岁'
                WHEN AGE BETWEEN 26 AND 30 THEN '26-30岁'
                WHEN AGE BETWEEN 31 AND 40 THEN '31-40岁'
                WHEN AGE BETWEEN 41 AND 50 THEN '41-50岁'
                WHEN AGE > 50 THEN '50岁以上'
                ELSE '未知'
                END AS ageRange,
            SUM(CASE WHEN NVL(GENDER, '') = '男' THEN 1 ELSE 0 END) AS male,
            SUM(CASE WHEN NVL(GENDER, '') = '女' THEN 1 ELSE 0 END) AS female,
            COUNT(EMP_ID) AS total
        FROM EMP  -- 直接查表，无需视图/子查询
        GROUP BY
            CASE
                WHEN AGE BETWEEN 18 AND 25 THEN '18-25岁'
                WHEN AGE BETWEEN 26 AND 30 THEN '26-30岁'
                WHEN AGE BETWEEN 31 AND 40 THEN '31-40岁'
                WHEN AGE BETWEEN 41 AND 50 THEN '41-50岁'
                WHEN AGE > 50 THEN '50岁以上'
                ELSE '未知'
                END
        ORDER BY
            CASE
                WHEN ageRange = '18-25岁' THEN 1
                WHEN ageRange = '26-30岁' THEN 2
                WHEN ageRange = '31-40岁' THEN 3
                WHEN ageRange = '41-50岁' THEN 4
                WHEN ageRange = '50岁以上' THEN 5
                ELSE 6
                END
    </select>

</mapper>