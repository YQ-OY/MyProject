<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wangchai.mapper.DeptMapper">
    <!--    查询部门下拉选项    -->
    <select id="getDeptOptions" resultType="com.wangchai.domain.vo.DeptOptionVo">
        SELECT NAME AS label,
               NAME AS value
        FROM DEPT
        ORDER BY DEPT_ID DESC
    </select>

    <!--    查询部门分页列表    -->
    <!-- 根据部门名称、主管编号查询DeptVo -->
    <select id="selectDeptVoPage" resultType="com.wangchai.domain.vo.DeptVo">
        SELECT
        d.DEPT_ID,
        d.NAME,
        d.MANAGER_EMP_ID,
        -- 部门经理姓名（左连接EMP表，避免无经理时数据丢失）
        nvl(m.NAME, '') AS MANAGER_NAME,
        -- 统计部门下员工数量（子查询，无员工时返回0）
        nvl((SELECT COUNT(e.EMP_ID) FROM EMP e WHERE e.DEPT_ID = d.DEPT_ID), 0) AS COUNT,
        d.DESCRIPTION
        FROM DEPT d
        -- 左连接EMP表查部门经理姓名（MANAGER_EMP_ID对应EMP的EMP_ID）
        LEFT JOIN EMP m ON d.MANAGER_EMP_ID = m.EMP_ID
        <where>
            <if test="dto.name != null and dto.name != ''">
                d.NAME LIKE '%' || #{dto.name} || '%'
            </if>
            <if test="dto.managerEmpId != null">
                AND d.MANAGER_EMP_ID = #{dto.managerEmpId}
            </if>
        </where>
        -- 部门ID排序
        ORDER BY d.DEPT_ID ASC
    </select>

     <!--    查询部门人数——饼图    -->
    <select id="DeptPersonCountData" resultType="com.wangchai.domain.vo.DeptPersonCountVo">
        SELECT
        d.NAME AS name,
        nvl((SELECT COUNT(e.EMP_ID) FROM EMP e WHERE e.DEPT_ID = d.DEPT_ID), 0) AS value
        FROM DEPT d
        ORDER BY value DESC
    </select>


</mapper>
